#!/usr/bin/julia
using Comonicon
using AllocationOpt

"""
Optimises an indexer's allocations.

# Arguments

- `id`: The id of the indexer to optimise.
- `filepath`: A path to the CSV file that contains whitelist, blacklist, pinnedlist, frozenlist as columns.
- `grtgas`: The maximum amount of GRT that you are willing to spend on each allocation transaction.
- `minimum_allocation_amount`: The minimum amount of GRT that you are willing to allocate to a subgraph.
- `allocation_lifetime`: The number of epoches you assume to open each allocations for. Lifetime 1 means an epoch should be closed in its second epoch
- `management_server_url`: The URL that exposes the indexer managment server, including the port. Example: http://localhost:18000.
"""
@main function main(id, filepath, grtgas, minimum_allocation_amount, allocation_lifetime, management_server_url)
    cols = read_filterlists(filepath)

    ω = optimize_indexer(id, cols..., parse(Float64, grtgas), parse(Float64, minimum_allocation_amount), parse(Int64, allocation_lifetime))
    @show ω
    
    # Push results to action queue
    push_allocations!(id, management_server_url, ω, cols...)
end
